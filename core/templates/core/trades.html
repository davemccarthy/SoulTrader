{% extends 'core/base.html' %}

{% block title %}Trades - SOULTRADER{% endblock %}

{% block content %}
{% if trades_chart_data_json %}
<div class="trades-graph-card">
    <div class="graph-header">
        <span class="graph-title">Trading history</span>
        <div class="graph-legend">
            <span class="legend-item">
                <span class="legend-line" style="background-color: rgba(16, 185, 129, 1);"></span>
                <span class="legend-label">Daily</span>
            </span>
            <span class="legend-item">
                <span class="legend-line" style="background-color: rgba(37, 99, 235, 1);"></span>
                <span class="legend-label">Cumulative</span>
            </span>
        </div>
    </div>
    <div class="trades-graph-body">
        <canvas id="trades-chart" aria-label="Trade P&L over time" role="img"></canvas>
    </div>
</div>
<script id="trades-chart-data" type="application/json">
    {{ trades_chart_data_json|safe }}
</script>
{% endif %}

<style>

    .trade-company {
        font-size: 0.82rem;
        color: #475569;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: 600;
    }

    .trade-company-col {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.15rem;
    }

    .trade-meta {
        font-size: 0.78rem;
        color: #475569;
        letter-spacing: 0.02em;
    }

    .trade-symbol {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.15rem;
    }

    .trade-timestamp {
        font-size: 0.78rem;
        color: #475569;
        letter-spacing: 0.02em;
    }

    .trade-action {
        font-weight: 700;
        font-size: 0.9rem;
    }

    .trade-action.buy {
        color: #059669;
    }

    .trade-action.sell {
        color: #dc2626;
    }

    .trades-empty {
        text-align: center;
        padding: 3rem;
        color: #64748b;
        font-size: 1rem;
    }

    .trades-grid {
        display: grid;
        grid-template-columns: 0.8fr 0.9fr 4.0fr 1.1fr 1.1fr 0.8fr 0.8fr 0.8fr;
        gap: 0.5rem;
        align-items: center;
        font-size: 0.875rem;
    }

    .trades-graph-card {
        margin: 0 1rem 1rem 1rem;
        padding: 1rem 1.25rem;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
    }


    .trades-graph-body {
        position: relative;
        height: 200px;
    }

</style>

<div class="holdings-container"
     data-detail-list-panel="#trades-list"
     data-detail-panel="#trade-detail-panel"
     data-detail-content="#trade-detail-content"
     data-detail-back="#trade-detail-back"
     data-detail-endpoint="/holdings/{id}/history/"
     data-detail-id-attr="data-stock-id">
    {% if trades %}
        <div id="trades-list" class="holdings-panel">
            {% for trade in trades %}
                <div class="holdings-row trades-grid"
                     data-trade-id="{{ trade.id }}"
                     data-stock-id="{{ trade.stock_id }}"
                     data-action="{{ trade.action }}">
                    <div class="holdings-col">
                        <img src="https://images.financialmodelingprep.com/symbol/{{ trade.symbol }}.png" alt="{{ trade.symbol }}" class="holdings-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <span class="trade-image-fallback" style="display:none;">{{ trade.symbol|slice:":2" }}</span>
                    </div>
                    <div class="holdings-col trade-symbol">
                        <span class="holdings-symbol">{{ trade.symbol }}</span>
                        {% if trade.timestamp %}
                            <span class="trade-timestamp">{{ trade.timestamp_display }}</span>
                        {% endif %}
                    </div>
                    <div class="holdings-col holdings-col-company trade-company-col">
                        <span class="trade-company" title="{{ trade.company }}">{{ trade.company|default:"—"|truncatechars:40 }}</span>
                        <span class="trade-meta" title="{{ trade.explanation }}">
                            {{ trade.explanation|default:"—"|truncatechars:80 }}
                        </span>
                    </div>

                    <div class="holdings-col">
                        <div class="holding-value-pair">
                            <div class="holding-value-pair-label">SHARES</div>
                            <div class="holding-value-pair-value">
                                {{ trade.shares }} @ ${{ trade.price|floatformat:2 }}
                            </div>
                        </div>
                    </div>

                    <div class="holdings-col">
                        <div class="holding-value-pair">
                            <div class="holding-value-pair-label">
                                {% if trade.action == 'BUY' %}OUTGOING ${% else %}INCOMING ${% endif %}
                            </div>
                            <div class="holding-value-pair-value">
                                {% if trade.action == 'BUY' %}
                                    -${{ trade.cost|floatformat:2 }}
                                {% else %}
                                    +${{ trade.cost|floatformat:2 }}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="holdings-col">
                        <div class="holding-value-pair">
                            <div class="holding-value-pair-label">P&L %</div>
                            <div class="holding-value-pair-value {{ trade.pl_class }}">
                                {% if trade.pl_percent is not None %}
                                    {% if trade.pl_percent >= 0 %}+{% endif %}{{ trade.pl_percent|floatformat:2 }}%
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="holdings-col">
                        <div class="holding-value-pair">
                            <div class="holding-value-pair-label">ACTION</div>
                            <div class="holding-value-pair-value">
                                <span class="trade-action {{ trade.action|lower }}">{{ trade.action }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="holdings-col">
                        {% if trade.discovery and trade.discovery.advisor_logo %}
                            <span class="holdings-advisor" title="{{ trade.discovery.advisor }}">
                                <span class="advisor-logo">
                                    <img src="{{ trade.discovery.advisor_logo }}" alt="{{ trade.discovery.advisor }}">
                                </span>
                                <span class="holdings-advisor-name">{{ trade.discovery.advisor }}</span>
                            </span>
                        {% elif trade.discovery and trade.discovery.advisor %}
                            <span class="holdings-discovery">
                                {{ trade.discovery.advisor|slice:":2"|upper }}
                            </span>
                        {% else %}
                            <span class="holdings-discovery">—</span>
                        {% endif %}
                    </div>
                    <!--
                    <div class="holdings-col">
                        {% if trade.action == 'BUY' %}
                            <span class="holdings-price">-${{ trade.cost|floatformat:2 }}</span>
                        {% else %}
                            <span class="holdings-price {{ trade.price_class }}">+${{ trade.cost|floatformat:2 }}</span>
                        {% endif %}
                    </div>
                    <div class="holdings-col">
                        {% if trade.pl_percent is not None %}
                            {% if trade.pl_percent >= 0 %}
                                <span class="holdings-change {{ trade.pl_class }}">+{{ trade.pl_percent|floatformat:2 }}%</span>
                            {% else %}
                                <span class="holdings-change {{ trade.pl_class }}">{{ trade.pl_percent|floatformat:2 }}%</span>
                            {% endif %}
                        {% else %}
                            <span class="holdings-change muted">—</span>
                        {% endif %}
                    </div>
                    <div class="holdings-col">
                        {% if trade.pl_amount is not None %}
                            {% if trade.pl_amount >= 0 %}
                                <span class="holdings-pl {{ trade.pl_class }}">+${{ trade.pl_amount|floatformat:2 }}</span>
                            {% else %}
                                <span class="holdings-pl {{ trade.pl_class }}">${{ trade.pl_amount|floatformat:2 }}</span>
                            {% endif %}
                        {% else %}
                            <span class="holdings-pl muted">—</span>
                        {% endif %}
                    </div>

                    <div class="holdings-col">
                        <span class="trade-action {{ trade.action|lower }}">{{ trade.action }}</span>
                    </div>-->
                </div>
            {% endfor %}
        </div>
        <div id="trade-detail-panel" class="holdings-panel holding-detail-panel" hidden>
            <div id="trade-detail-content" class="holding-detail-content"></div>
            <button type="button" id="trade-detail-back" class="holding-detail-back" hidden>← Back to trades</button>
        </div>
    {% else %}
        <div class="trades-empty">
            No trades yet. Run a smart analysis to generate activity.
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('trades-chart');
    const dataScript = document.getElementById('trades-chart-data');
    if (!canvas || !dataScript || typeof Chart === 'undefined') {
        return;
    }

    let points;
    try {
        points = JSON.parse(dataScript.textContent || '[]');
    } catch (e) {
        console.error('Invalid trades chart data', e);
        return;
    }

    if (!Array.isArray(points) || points.length === 0) {
        return;
    }

    const ctx = canvas.getContext('2d');

    const chartConfig = {
        type: 'line',
        data: {
            labels: points.map(p => {
                const d = new Date(p.date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }),
            datasets: [
                {
                    label: 'Daily',
                    data: points.map(p => p.trade_daily),
                    borderColor: 'rgba(16, 185, 129, 1)',  // green
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                },
                {
                    label: 'Cumulative',
                    data: points.map(p => p.trade_cumulative),
                    borderColor: 'rgba(37, 99, 235, 1)',  // blue
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                title: {
                    display: false,
                },
                legend: {
                    display: false,
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y || 0;
                            const formatted = (value >= 0 ? '+' : '') + value.toFixed(2) + '%';
                            const label = context.dataset.label || '';
                            return label + ': ' + formatted;
                        },
                        title: function(items) {
                            if (!items.length) return '';
                            return items[0].label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false,
                    }
                },
                y: {
                    ticks: {
                        callback: function(value) {
                            return (value >= 0 ? '+' : '') + value.toFixed(1) + '%';
                        }
                    },
                    grid: {
                        color: 'rgba(148, 163, 184, 0.2)',
                    }
                }
            }
        }
    };

    new Chart(ctx, chartConfig);
});
</script>
{% endblock %}

