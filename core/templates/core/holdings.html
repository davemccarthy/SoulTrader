{% extends 'core/base.html' %}

{% block title %}Holdings - SOULTRADER{% endblock %}

{% block content %}
<div class="holdings-container" 
     data-detail-list-panel="#holdings-list"
     data-detail-panel="#holding-detail-panel"
     data-detail-content="#holding-detail-content"
     data-detail-back="#holding-detail-back"
     data-detail-endpoint="/holdings/{id}/detail/"
     data-detail-id-attr="data-stock-id">
    {% if holdings %}
        <div id="holdings-list" class="holdings-panel">
            {% for holding in holdings %}
                <div class="holdings-row holdings-grid" data-stock-id="{{ holding.stock_id }}">
                    <div class="holdings-col">
                        <img src="https://images.financialmodelingprep.com/symbol/{{ holding.symbol }}.png" alt="{{ holding.symbol }}" class="holdings-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="holdings-image" style="display:none; background: #f0f0f0; align-items: center; justify-content: center; font-size: 0.7rem; color: #999;">
                            {{ holding.symbol|slice:":2" }}
                        </div>
                    </div>
                    <div class="holdings-col holdings-col-symbol">
                        <span class="holdings-symbol">{{ holding.symbol }}</span>
                        <span class="holdings-symbol-value">${{ holding.total_value|floatformat:2 }}</span>
                    </div>
                    <div class="holdings-col holdings-col-company">
                        <span class="holdings-company" title="{{ holding.company }}">{{ holding.company|default:"‚Äî"|truncatechars:40 }}</span>
                        <span class="holdings-company-meta">{{ holding.shares|default:"‚Äî" }} @ ${{ holding.average_price|floatformat:2 }}</span>
                    </div>
                    <div class="holdings-col">
                        <span class="holdings-price {{ holding.price_class }}">${{ holding.price|floatformat:2 }}</span>
                    </div>
                    <div class="holdings-col">
                        {% if holding.change_percent >= 0 %}
                            <span class="holdings-change positive">+{{ holding.change_percent|floatformat:0 }}%</span>
                        {% else %}
                            <span class="holdings-change negative">{{ holding.change_percent|floatformat:0 }}%</span>
                        {% endif %}
                    </div>
                    <div class="holdings-col">
                        {% if holding.pl >= 0 %}
                            <span class="holdings-pl positive">${{ holding.pl|floatformat:2 }}</span>
                        {% else %}
                            <span class="holdings-pl negative">${{ holding.pl|floatformat:2 }}</span>
                        {% endif %}
                    </div>
                    <div class="holdings-col">
                        {% if holding.discovery_logo %}
                            <span class="holdings-advisor" title="{{ holding.discovery }}">
                                <span class="advisor-logo"><img src="{{ holding.discovery_logo }}" alt="{{ holding.discovery }}"></span>
                                <span class="holdings-advisor-name">{{ holding.discovery }}</span>
                            </span>
                        {% elif holding.discovery %}
                            <span class="holdings-discovery">{{ holding.discovery|slice:":2"|upper }}</span>
                        {% else %}
                            <span class="holdings-discovery">‚Äî</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="holding-detail-panel" class="holdings-panel holding-detail-panel" hidden>
            <div id="holding-detail-content" class="holding-detail-content"></div>
            <button type="button" id="holding-detail-back" class="holding-detail-back" hidden>‚Üê Back to holdings</button>
        </div>
    {% else %}
        <div class="holdings-empty">
            <p>No holdings found. Start trading to see your positions here.</p>
        </div>
    {% endif %}
</div>

<script>
// Holdings-specific renderer for detail panel
window.detailPanelRenderer = function(data) {
    function escapeHtml(value) {
        return String(value ?? '').replace(/[&<>"']/g, (char) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
        })[char]);
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(value ?? 0);
    }

    function formatPercent(value) {
        const fixed = Number(value ?? 0).toFixed(2);
        return `${value >= 0 ? '+' : ''}${fixed}%`;
    }

    function formatDecimal(value) {
        const num = Number(value);
        return Number.isFinite(num) ? num.toFixed(2) : '‚Äî';
    }

    function renderAdvisorBadge(label, logoUrl) {
        const fallback = label ? escapeHtml(label.slice(0, 2)) : 'AD';
        if (logoUrl) {
            const safeUrl = escapeHtml(logoUrl);
            const alt = label ? escapeHtml(label) : 'Advisor logo';
            return `<div class="trade-advisor-logo"><img src="${safeUrl}" alt="${alt}"></div>`;
        }
        return `<div class="trade-advisor-logo">${fallback}</div>`;
    }

    function formatExplanation(text) {
        if (!text) {
            return '';
        }

        const normalized = text
            .replace(/\s+/g, ' ')
            .trim();

        if (!normalized) {
            return '';
        }

        const segments = normalized.split('|').map((segment) => segment.trim()).filter(Boolean);

        const clauses = [];
        for (let i = 0; i < segments.length; i += 1) {
            const current = segments[i];
            if (!current) {
                continue;
            }

            const articleInlineMatch = current.match(/^article\s*:\s*(.+)$/i);
            if (articleInlineMatch && i + 1 < segments.length) {
                const titleRaw = articleInlineMatch[1];
                const urlRaw = segments[i + 1];

                if (titleRaw && /^https?:\/\/\S+/i.test(urlRaw)) {
                    const safeTitle = escapeHtml(titleRaw.trim());
                    const safeUrl = escapeHtml(urlRaw.trim());
                    clauses.push(`<span class="explanation-article"><a href="${safeUrl}" target="_blank" rel="noopener">${safeTitle}</a></span>`);
                    i += 1;
                    continue;
                }
            }

            const bareUrlMatch = current.match(/^https?:\/\/\S+$/i);
            if (bareUrlMatch) {
                const safeUrl = escapeHtml(current);
                clauses.push(`<a href="${safeUrl}" target="_blank" rel="noopener">${safeUrl}</a>`);
                continue;
            }

            clauses.push(escapeHtml(current));
        }

        if (!clauses.length) {
            return '';
        }

        let result = '';
        clauses.forEach((clause, index) => {
            result += clause;
            if (index < clauses.length - 1) {
                const isArticleClause = clause.startsWith('<span class="explanation-article">');
                result += isArticleClause ? ' ' : '<br>';
            }
        });

        return result;
    }

    function renderDiscoverySection(discovery) {
        if (!discovery) {
            return '';
        }

        const advisor = escapeHtml(discovery.advisor || 'Unknown advisor');
        const started = discovery.sa_started ? escapeHtml(new Date(discovery.sa_started).toLocaleString()) : '';
        const explanation = formatExplanation(discovery.explanation || '');
        const saId = escapeHtml(discovery.sa_id);
        const badge = renderAdvisorBadge(discovery.advisor || '', discovery.advisor_logo);

        return `
            <div class="trade-detail-panel">
                <div class="trade-advisor-header">
                    ${badge}
                    <div class="trade-recommendation-copy">
                        <strong>Discovered by ${advisor}</strong>
                        <div class="trade-recommendation-confidence">${started ? `${started} ¬∑ ` : ''}SA #${saId}</div>
                    </div>
                </div>
                <div class="trade-discovery-explanation">${explanation}</div>
            </div>
        `;
    }

    function renderRecommendationsSection(recommendations) {
        if (!recommendations || !recommendations.length) {
            return '';
        }

        const entries = recommendations.map((rec) => {
            const advisor = escapeHtml(rec.advisor || 'Unknown advisor');
            const confidence = rec.confidence != null ? Number(rec.confidence).toFixed(2) : '‚Äî';
            const explanation = formatExplanation(rec.explanation || '');
            const badge = renderAdvisorBadge(rec.advisor || '', rec.advisor_logo);

            return `
                <div class="trade-recommendation-entry">
                    <div class="trade-advisor-header">
                        ${badge}
                        <div class="trade-recommendation-copy">
                            <strong>${advisor}</strong>
                            <div class="trade-recommendation-confidence">Confidence score ${confidence}</div>
                        </div>
                    </div>
                    <div>${explanation}</div>
                </div>
            `;
        }).join('');

        return `
            <div class="trade-section">
                <h6 class="trade-section-title">Analysis</h6>
                <div class="trade-detail-panel">
                    <div class="trade-advisor-grid">${entries}</div>
                </div>
            </div>
        `;
    }

    function renderTradeCard(trade, currentPrice) {
        const action = escapeHtml(trade.action || 'UNKNOWN');
        const shares = escapeHtml(trade.shares);
        const price = trade.price != null ? formatCurrency(trade.price) : '‚Äî';
        const value = trade.value != null ? formatCurrency(trade.value) : '‚Äî';
        const valueLabel = (trade.action || '').toUpperCase() === 'SELL' ? 'Proceeds' : 'Cost';
        const saId = escapeHtml(trade.sa_id || '‚Äî');
        const discoveryBlock = renderDiscoverySection(trade.discovery);
        const recommendationsBlock = renderRecommendationsSection(trade.recommendations);
        const sellInstructionsBlock = renderSellInstructionsSection(trade.sell_instructions || [], currentPrice);

        return `
            <div class="trade-card">
                <div class="trade-card-header">
                    <h5 class="trade-card-title">${action} ${shares} @ ${price}</h5>
                    <div class="trade-card-meta">
                        <span>${valueLabel} ${value}</span>
                        <span>SA #${saId}</span>
                    </div>
                </div>
                ${discoveryBlock}
                ${recommendationsBlock}
                ${sellInstructionsBlock}
            </div>
        `;
    }

    function renderSellInstructionsSection(sellInstructions, currentPrice) {
        if (!sellInstructions || !sellInstructions.length) {
            return '';
        }

        const instructionEmojis = {
            'STOP_LOSS': 'üõë',
            'TARGET_PRICE': 'üéØ',
            'CS_FLOOR': 'üìâ',
            'AFTER_DAYS': 'üìÖ',
        };

        const instructionLabels = {
            'STOP_LOSS': 'STOP LOSS',
            'TARGET_PRICE': 'TARGET PRICE',
            'CS_FLOOR': 'CS FLOOR',
            'AFTER_DAYS': 'AFTER DAYS',
        };

        const entries = sellInstructions.map((inst) => {
            const emoji = instructionEmojis[inst.instruction] || 'üìå';
            const label = instructionLabels[inst.instruction] || inst.instruction;
            let valueDisplay = '';
            let extraInfo = '';

            if (inst.instruction === 'STOP_LOSS' && inst.value != null) {
                valueDisplay = formatCurrency(inst.value);
                if (inst.current_price != null) {
                    const diff = inst.current_price - inst.value;
                    const diffPercent = inst.value > 0 ? ((diff / inst.value) * 100) : 0;
                    extraInfo = ` (${diffPercent >= 0 ? '+' : ''}${diffPercent.toFixed(1)}% from current)`;
                }
            } else if (inst.instruction === 'TARGET_PRICE' && inst.value != null) {
                valueDisplay = formatCurrency(inst.value);
                if (inst.current_price != null) {
                    const upside = inst.value - inst.current_price;
                    const upsidePercent = inst.current_price > 0 ? ((upside / inst.current_price) * 100) : 0;
                    extraInfo = ` (+${upsidePercent.toFixed(1)}% upside)`;
                }
            } else if (inst.instruction === 'AFTER_DAYS' && inst.value != null) {
                valueDisplay = `${inst.value} days`;
                if (inst.days_held != null) {
                    const remaining = Math.max(0, inst.value - inst.days_held);
                    extraInfo = ` (${inst.days_held} days held, ${remaining} remaining)`;
                }
            } else if (inst.instruction === 'CS_FLOOR' && inst.value != null) {
                valueDisplay = inst.value.toFixed(2);
                if (inst.current_consensus != null) {
                    const diff = inst.current_consensus - inst.value;
                    extraInfo = ` (Current: ${inst.current_consensus.toFixed(2)}, ${diff >= 0 ? '+' : ''}${diff.toFixed(2)} above floor)`;
                }
            }

            const statusIndicator = inst.status === 'active' ? ' ‚ö†Ô∏è TRIGGERED' : '';
            const text = `${emoji} ${label}: ${valueDisplay}${extraInfo}${statusIndicator}`;
            
            return `
                <div>${escapeHtml(text)}</div>
            `;
        }).join('');

        return `
            <div class="trade-section">
                <h6 class="trade-section-title">Sell Instructions</h6>
                <div class="trade-detail-panel">
                    <div class="trade-recommendation-entry">
                        ${entries}
                    </dive>
                </div>
            </div>
        `;
    }

    // Main rendering logic
    const plClass = data.holding.pl_percent >= 0 ? 'positive' : 'negative';
    const symbolRaw = (data.stock.symbol || '').toString();
    const companyRaw = data.stock.company || '';

    const symbol = escapeHtml(symbolRaw);
    const company = escapeHtml(companyRaw);

    const holdingShares = escapeHtml(data.holding.shares);
    const averagePrice = escapeHtml(formatCurrency(data.holding.average_price));
    const currentPrice = escapeHtml(formatCurrency(data.stock.price));
    const returnAmount = escapeHtml(formatCurrency(data.holding.return_amount));
    const percentDisplay = escapeHtml(formatPercent(data.holding.pl_percent));
    const worth = escapeHtml(formatCurrency(data.holding.worth));
    const consensus = (data.trades || []).find((trade) => trade.consensus)?.consensus || null;

    const consensusRecommendations = consensus && consensus.recommendations != null
        ? escapeHtml(consensus.recommendations)
        : null;
    const consensusAverage = consensus && consensus.avg_confidence != null
        ? escapeHtml(formatDecimal(consensus.avg_confidence))
        : null;
    const consensusTotal = consensus && consensus.tot_confidence != null
        ? escapeHtml(formatDecimal(consensus.tot_confidence))
        : null;

    const metricItems = [
        `<span>Shares ${holdingShares}</span>`,
        `<span>Average ${averagePrice}</span>`,
        `<span>Current ${currentPrice}</span>`,
        `<span>Value ${worth}</span>`,
        `<span class="holding-detail-return ${plClass}">Return ${returnAmount} (${percentDisplay})</span>`,
    ];

    if (consensusRecommendations != null) {
        metricItems.push(`<span>Recommendations ${consensusRecommendations}</span>`);
    }
    if (consensusAverage != null) {
        metricItems.push(`<span>Average confidence ${consensusAverage}</span>`);
    }
    if (consensusTotal != null) {
        metricItems.push(`<span>Total confidence ${consensusTotal}</span>`);
    }

    const tradesHtml = data.trades.length
        ? `<div class="trade-list">${data.trades.map(trade => renderTradeCard(trade, data.stock.price)).join('')}</div>`
        : '<p class="holding-detail-empty">No trades recorded for this holding yet.</p>';

    return `
        <div class="holding-detail-header">
            <div class="holding-detail-logo" style="position: relative;">
                <img src="https://images.financialmodelingprep.com/symbol/${symbol}.png" alt="${symbol}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <span style="display: none !important; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; align-items: center; justify-content: center; font-size: 0.7rem; color: #999;">${escapeHtml(symbolRaw.slice(0, 2))}</span>
            </div>
            <div class="holding-detail-summary">
                <h3>${symbol} ¬∑ ${company}</h3>
                <div class="holding-detail-metrics">
                    ${metricItems.join('')}
                </div>
            </div>
        </div>
        <div class="holding-detail-section">
            ${tradesHtml}
        </div>
    `;
};
</script>
{% endblock %}

