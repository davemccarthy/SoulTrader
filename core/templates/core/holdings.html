{% extends 'core/base.html' %}

{% block title %}Holdings - SOULTRADER{% endblock %}

{% block content %}
<div class="holdings-container" 
     data-detail-list-panel="#holdings-list"
     data-detail-panel="#holding-detail-panel"
     data-detail-content="#holding-detail-content"
     data-detail-back="#holding-detail-back"
     data-detail-endpoint="/holdings/{id}/history/"
     data-detail-id-attr="data-stock-id">
    {% if holdings %}
        <div id="holdings-list" class="holdings-panel">
            {% for holding in holdings %}
                <div class="holdings-row holdings-grid" data-stock-id="{{ holding.stock_id }}">
                    <div class="holdings-col">
                        <img src="https://images.financialmodelingprep.com/symbol/{{ holding.symbol }}.png" alt="{{ holding.symbol }}" class="holdings-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="holdings-image" style="display:none; background: #f0f0f0; align-items: center; justify-content: center; font-size: 0.7rem; color: #999;">
                            {{ holding.symbol|slice:":2" }}
                        </div>
                    </div>
                    <div class="holdings-col holdings-col-symbol">
                        <span class="holdings-symbol">{{ holding.symbol }}</span>
                        <span class="holdings-symbol-value">${{ holding.total_value|floatformat:2 }}</span>
                    </div>
                    <div class="holdings-col holdings-col-company">
                        <span class="holdings-company" title="{{ holding.company }}">{{ holding.company|default:"‚Äî"|truncatechars:40 }}</span>
                    </div>
                    <div class="holdings-col">
                        <span class="holdings-price {{ holding.price_class }}">${{ holding.price|floatformat:2 }}</span>
                    </div>
                    <div class="holdings-col">
                        {% if holding.change_percent >= 0 %}
                            <span class="holdings-change positive">+{{ holding.change_percent|floatformat:2 }}%</span>
                        {% else %}
                            <span class="holdings-change negative">{{ holding.change_percent|floatformat:2 }}%</span>
                        {% endif %}
                    </div>
                    <div class="holdings-col">
                        {% if holding.pl >= 0 %}
                            <span class="holdings-pl positive">${{ holding.pl|floatformat:2 }}</span>
                        {% else %}
                            <span class="holdings-pl negative">${{ holding.pl|floatformat:2 }}</span>
                        {% endif %}
                    </div>
                    <div class="holdings-col">
                        {% if holding.discovery_logo %}
                            <span class="holdings-advisor" title="{{ holding.discovery }}">
                                <span class="advisor-logo"><img src="{{ holding.discovery_logo }}" alt="{{ holding.discovery }}"></span>
                                <span class="holdings-advisor-name">{{ holding.discovery }}</span>
                            </span>
                        {% elif holding.discovery %}
                            <span class="holdings-discovery">{{ holding.discovery|slice:":2"|upper }}</span>
                        {% else %}
                            <span class="holdings-discovery">‚Äî</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="holding-detail-panel" class="holdings-panel holding-detail-panel" hidden>
            <div id="holding-detail-content" class="holding-detail-content"></div>
            <button type="button" id="holding-detail-back" class="holding-detail-back" hidden>‚Üê Back to holdings</button>
        </div>
    {% else %}
        <div class="holdings-empty">
            <p>No holdings found. Start trading to see your positions here.</p>
        </div>
    {% endif %}
</div>

<script>
// Holdings-specific renderer for detail panel
window.detailPanelRenderer = function(data) {
    function escapeHtml(value) {
        return String(value ?? '').replace(/[&<>"']/g, (char) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
        })[char]);
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(value ?? 0);
    }

    function formatPercent(value) {
        const fixed = Number(value ?? 0).toFixed(2);
        return `${value >= 0 ? '+' : ''}${fixed}%`;
    }

    function formatDecimal(value) {
        const num = Number(value);
        return Number.isFinite(num) ? num.toFixed(2) : '‚Äî';
    }

    function renderAdvisorBadge(label, logoUrl) {
        const fallback = label ? escapeHtml(label.slice(0, 2)) : 'AD';
        if (logoUrl) {
            const safeUrl = escapeHtml(logoUrl);
            const alt = label ? escapeHtml(label) : 'Advisor logo';
            return `<div class="trade-advisor-logo"><img src="${safeUrl}" alt="${alt}"></div>`;
        }
        return `<div class="trade-advisor-logo">${fallback}</div>`;
    }

    function formatExplanation(text) {
        if (!text) {
            return '';
        }

        const normalized = text
            .replace(/\s+/g, ' ')
            .trim();

        if (!normalized) {
            return '';
        }

        const segments = normalized.split('|').map((segment) => segment.trim()).filter(Boolean);

        const clauses = [];
        for (let i = 0; i < segments.length; i += 1) {
            const current = segments[i];
            if (!current) {
                continue;
            }

            const articleInlineMatch = current.match(/^article\s*:\s*(.+)$/i);
            if (articleInlineMatch && i + 1 < segments.length) {
                const titleRaw = articleInlineMatch[1];
                const urlRaw = segments[i + 1];

                if (titleRaw && /^https?:\/\/\S+/i.test(urlRaw)) {
                    const safeTitle = escapeHtml(titleRaw.trim());
                    const safeUrl = escapeHtml(urlRaw.trim());
                    clauses.push(`<span class="explanation-article"><a href="${safeUrl}" target="_blank" rel="noopener">${safeTitle}</a></span>`);
                    i += 1;
                    continue;
                }
            }

            const bareUrlMatch = current.match(/^https?:\/\/\S+$/i);
            if (bareUrlMatch) {
                const safeUrl = escapeHtml(current);
                clauses.push(`<a href="${safeUrl}" target="_blank" rel="noopener">${safeUrl}</a>`);
                continue;
            }

            clauses.push(escapeHtml(current));
        }

        if (!clauses.length) {
            return '';
        }

        let result = '';
        clauses.forEach((clause, index) => {
            result += clause;
            if (index < clauses.length - 1) {
                const isArticleClause = clause.startsWith('<span class="explanation-article">');
                result += isArticleClause ? ' ' : '<br>';
            }
        });

        return result;
    }

    function renderDiscoverySection(discovery) {
        if (!discovery) {
            return '';
        }

        const advisor = escapeHtml(discovery.advisor || 'Unknown advisor');
        const started = discovery.sa_started ? escapeHtml(new Date(discovery.sa_started).toLocaleString()) : '';
        const explanation = formatExplanation(discovery.explanation || '');
        const saId = escapeHtml(discovery.sa_id);
        const badge = renderAdvisorBadge(discovery.advisor || '', discovery.advisor_logo);

        return `
            <div class="trade-detail-panel">
                <div class="trade-advisor-header">
                    ${badge}
                    <div class="trade-recommendation-copy">
                        <strong>Discovered by ${advisor}</strong>
                        <div class="trade-recommendation-confidence">${started ? `${started} ¬∑ ` : ''}SA #${saId}</div>
                    </div>
                </div>
                <div class="trade-discovery-explanation">${explanation}</div>
            </div>
        `;
    }

    function renderRecommendationsSection(recommendations) {
        if (!recommendations || !recommendations.length) {
            return '';
        }

        const entries = recommendations.map((rec) => {
            const advisor = escapeHtml(rec.advisor || 'Unknown advisor');
            const confidence = rec.confidence != null ? Number(rec.confidence).toFixed(2) : '‚Äî';
            const explanation = formatExplanation(rec.explanation || '');
            const badge = renderAdvisorBadge(rec.advisor || '', rec.advisor_logo);

            return `
                <div class="trade-recommendation-entry">
                    <div class="trade-advisor-header">
                        ${badge}
                        <div class="trade-recommendation-copy">
                            <strong>${advisor}</strong>
                            <div class="trade-recommendation-confidence">Confidence score ${confidence}</div>
                        </div>
                    </div>
                    <div>${explanation}</div>
                </div>
            `;
        }).join('');

        return `
            <div class="trade-section">
                <h6 class="trade-section-title">Analysis</h6>
                <div class="trade-detail-panel">
                    <div class="trade-advisor-grid">${entries}</div>
                </div>
            </div>
        `;
    }

    function renderTradeCard(trade, currentPrice) {
        const action = escapeHtml(trade.action || 'UNKNOWN');
        const shares = escapeHtml(trade.shares);
        const price = trade.price != null ? formatCurrency(trade.price) : '‚Äî';
        const value = trade.value != null ? formatCurrency(trade.value) : '‚Äî';
        const valueLabel = (trade.action || '').toUpperCase() === 'SELL' ? 'Proceeds' : 'Cost';
        const saId = escapeHtml(trade.sa_id || '‚Äî');
        const discoveryBlock = renderDiscoverySection(trade.discovery);
        const recommendationsBlock = renderRecommendationsSection(trade.recommendations);
        const sellInstructionsBlock = renderSellInstructionsSection(trade.sell_instructions || [], currentPrice);
        const tradeDate = new Date(trade.created);
        const created = tradeDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        return `
            <div class="trade-card">
                <div class="trade-card-header">
                    <h5 class="trade-card-title">${action} ${shares} @ ${price}</h5>
                    <div class="trade-card-meta">
                        <span>${valueLabel} ${value}</span>
                        <span>${created}</span>
                    </div>
                </div>
                ${discoveryBlock}
                ${recommendationsBlock}
                ${sellInstructionsBlock}
            </div>
        `;
    }

    function renderSellInstructionsSection(sellInstructions, currentPrice) {
        if (!sellInstructions || !sellInstructions.length) {
            return '';
        }

        const instructionEmojis = {
            'STOP_LOSS': 'üõë',
            'STOP_PRICE': 'üõë',
            'STOP_PERCENTAGE': 'üõë',
            'TARGET_PRICE': 'üéØ',
            'TARGET_PERCENTAGE': 'üéØ',
            'CS_FLOOR': 'üìâ',
            'AFTER_DAYS': 'üìÖ',
            'DESCENDING_TREND': 'üìâ',
        };

        const instructionLabels = {
            'STOP_LOSS': 'STOP LOSS',
            'STOP_PRICE': 'STOP PRICE',
            'STOP_PERCENTAGE': 'STOP %',
            'TARGET_PRICE': 'TARGET PRICE',
            'TARGET_PERCENTAGE': 'TARGET %',
            'CS_FLOOR': 'CS FLOOR',
            'AFTER_DAYS': 'AFTER DAYS',
            'DESCENDING_TREND': 'DESCENDING TREND',
        };

        const entries = sellInstructions.map((inst) => {
            const emoji = instructionEmojis[inst.instruction] || 'üìå';
            const label = instructionLabels[inst.instruction] || inst.instruction;
            let valueDisplay = '';
            let extraInfo = '';

            if (['STOP_LOSS', 'STOP_PERCENTAGE', 'STOP_PRICE'].includes(inst.instruction) && inst.value != null) {
                valueDisplay = formatCurrency(inst.value);
                if (inst.current_price != null) {
                    const diff = inst.current_price - inst.value;
                    const diffPercent = inst.current_price > 0 ? ((diff / inst.current_price) * 100) : 0;
                    extraInfo = ` (${diffPercent >= 0 ? '+' : ''}${diffPercent.toFixed(1)}% from current)`;
                }
            } else if (['TARGET_PRICE', 'TARGET_PERCENTAGE'].includes(inst.instruction) && inst.value != null) {
                valueDisplay = formatCurrency(inst.value);
                if (inst.current_price != null) {
                    const upside = inst.value - inst.current_price;
                    const upsidePercent = inst.current_price > 0 ? ((upside / inst.current_price) * 100) : 0;
                    extraInfo = ` (+${upsidePercent.toFixed(1)}% upside)`;
                }
            } else if (inst.instruction === 'AFTER_DAYS' && inst.value != null) {
                valueDisplay = `${inst.value} days`;
                if (inst.days_held != null) {
                    const remaining = Math.max(0, inst.value - inst.days_held);
                    extraInfo = ` (${inst.days_held} days held, ${remaining} remaining)`;
                }
            } else if (inst.instruction === 'CS_FLOOR' && inst.value != null) {
                valueDisplay = inst.value.toFixed(2);
                if (inst.current_consensus != null) {
                    const diff = inst.current_consensus - inst.value;
                    extraInfo = ` (Current: ${inst.current_consensus.toFixed(2)}, ${diff >= 0 ? '+' : ''}${diff.toFixed(2)} above floor)`;
                }
            } else if (inst.instruction === 'DESCENDING_TREND' && inst.value != null) {
                valueDisplay = `${(inst.value * 100).toFixed(1)}%`;
                if (inst.current_trend != null) {
                    const diff = inst.current_trend - inst.value;
                    extraInfo = ` (Current trend: ${(inst.current_trend * 100).toFixed(1)}%, ${diff >= 0 ? '+' : ''}${(diff * 100).toFixed(1)}% from threshold)`;
                }
            }

            const statusIndicator = inst.status === 'active' ? ' ‚ö†Ô∏è TRIGGERED' : '';
            const text = `${emoji} ${label}: ${valueDisplay}${extraInfo}${statusIndicator}`;
            
            return `
                <div>${escapeHtml(text)}</div>
            `;
        }).join('');

        return `
            <div class="trade-section">
                <h6 class="trade-section-title">Sell Instructions</h6>
                <div class="trade-detail-panel">
                    <div class="trade-recommendation-entry">
                        ${entries}
                    </div>
                </div>
            </div>
        `;
    }

    // Main rendering logic
    const plClass = data.holding.pl_percent >= 0 ? 'positive' : 'negative';
    const symbolRaw = (data.stock.symbol || '').toString();
    const companyRaw = data.stock.company || '';

    const symbol = escapeHtml(symbolRaw);
    const company = escapeHtml(companyRaw);

    const holdingShares = escapeHtml(data.holding.shares);
    const averagePrice = escapeHtml(formatCurrency(data.holding.average_price));
    const currentPrice = escapeHtml(formatCurrency(data.stock.price));
    const returnAmount = escapeHtml(formatCurrency(data.holding.return_amount));
    const percentDisplay = escapeHtml(formatPercent(data.holding.pl_percent));
    const worth = escapeHtml(formatCurrency(data.holding.worth));
    const consensus = (data.trades || []).find((trade) => trade.consensus)?.consensus || null;

    const consensusRecommendations = consensus && consensus.recommendations != null
        ? escapeHtml(consensus.recommendations)
        : null;
    const consensusAverage = consensus && consensus.avg_confidence != null
        ? escapeHtml(formatDecimal(consensus.avg_confidence))
        : null;
    const consensusTotal = consensus && consensus.tot_confidence != null
        ? escapeHtml(formatDecimal(consensus.tot_confidence))
        : null;

    const metricItems = [
        `<span>Shares ${holdingShares}</span>`,
        `<span>Average ${averagePrice}</span>`,
        `<span>Current ${currentPrice}</span>`,
        `<span>Value ${worth}</span>`,
        `<span class="holding-detail-return ${plClass}">Return ${returnAmount} (${percentDisplay})</span>`,
    ];

    if (consensusRecommendations != null) {
        metricItems.push(`<span>Recommendations ${consensusRecommendations}</span>`);
    }
    if (consensusAverage != null) {
        metricItems.push(`<span>Average confidence ${consensusAverage}</span>`);
    }
    if (consensusTotal != null) {
        metricItems.push(`<span>Total confidence ${consensusTotal}</span>`);
    }

    // Add trend to metrics
    const trendValue = data.stock.trend != null ? parseFloat(data.stock.trend) : null;
    const trendClass = data.stock.trend_class || 'neutral';
    if (trendValue != null) {
        metricItems.push(`<span class="holding-detail-trend ${trendClass}">Trend ${trendValue.toFixed(8)}</span>`);
    }

    const tradesHtml = data.trades.length
        ? `<div class="trade-list">${data.trades.map(trade => renderTradeCard(trade, data.stock.price)).join('')}</div>`
        : '<p class="holding-detail-empty">No trades recorded for this holding yet.</p>';

    return `
        <div class="holding-detail-header">
            <div class="holding-detail-logo" style="position: relative;">
                <img src="https://images.financialmodelingprep.com/symbol/${symbol}.png" alt="${symbol}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <span style="display: none !important; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; align-items: center; justify-content: center; font-size: 0.7rem; color: #999;">${escapeHtml(symbolRaw.slice(0, 2))}</span>
            </div>
            <div class="holding-detail-summary">
                <h3>${symbol} ¬∑ ${company}</h3>
                <div class="holding-detail-metrics">
                    ${metricItems.join('')}
                </div>
            </div>
        </div>
        <div class="holding-detail-section">
            ${tradesHtml}
        </div>
    `;
};

// Holdings history renderer - unified view with heading, discovery, health history, and trade history
window.holdingHistoryRenderer = function(data) {
    function escapeHtml(value) {
        return String(value ?? '').replace(/[&<>"]/g, (char) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
        })[char]);
    }

    function formatCurrency(value) {
        if (value == null) return '‚Äî';
        const formatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        return formatted.replace(/^US\s*/, ''); // Remove "US " prefix if present
    }

    function formatPercent(value) {
        if (value == null) return '‚Äî';
        const fixed = Number(value).toFixed(2);
        return `${value >= 0 ? '+' : ''}${fixed}%`;
    }

    function formatDate(dateString) {
        if (!dateString) return '‚Äî';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    function formatDateTime(dateString) {
        if (!dateString) return '‚Äî';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        }) + ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function formatGeminiExplanation(text) {
        if (!text) return '';
        // Convert markdown-style formatting to HTML
        let html = escapeHtml(text);
        // Bold text **text**
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // Lists starting with * or -
        html = html.replace(/^[\*\-]\s+(.+)$/gm, '<li>$1</li>');
        // Wrap consecutive list items in <ul>
        html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
        // Line breaks
        html = html.replace(/\n/g, '<br>');
        return html;
    }

    // Render heading section
    function renderHeadingSection(heading) {
        if (!heading) return '';
        const symbol = escapeHtml(heading.symbol || '');
        const company = escapeHtml(heading.company || '');
        const image = heading.image || '';
        const avgPrice = formatCurrency(heading.average_price);
        const worth = formatCurrency(heading.worth);
        const shares = heading.shares || 0;
        const price = formatCurrency(heading.price);
        const changePercent = formatPercent(heading.change_percent);
        const priceClass = heading.price_class || 'neutral';
        const changeClass = heading.change_class || 'neutral';

        return `
            <div class="holding-heading">
                ${image ? `<img src="${escapeHtml(image)}" alt="${symbol}" class="holding-heading-logo" onerror="this.style.display='none';">` : ''}
                <div class="holding-heading-info">
                    <h2>${symbol} ¬∑ ${company}</h2>
                    <div class="holding-heading-metrics">
                        <div class="holding-heading-metric">
                            <span class="holding-heading-label">Avg Price</span>
                            <span class="holding-heading-value">${avgPrice}</span>
                        </div>
                        <div class="holding-heading-metric">
                            <span class="holding-heading-label">Worth</span>
                            <span class="holding-heading-value">${worth}</span>
                        </div>
                        <div class="holding-heading-metric">
                            <span class="holding-heading-label">Shares</span>
                            <span class="holding-heading-value">${shares}</span>
                        </div>
                        <div class="holding-heading-metric">
                            <span class="holding-heading-label">Price</span>
                            <span class="holding-heading-value ${priceClass}">${price}</span>
                        </div>
                        <div class="holding-heading-metric">
                            <span class="holding-heading-label">Change</span>
                            <span class="holding-heading-value ${changeClass}">${changePercent}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Render discovery section
    function renderDiscoverySection(discovery) {
        if (!discovery) return '';
        const advisor = escapeHtml(discovery.advisor || '');
        const advisorLogo = discovery.advisor_logo || '';
        const explanation = discovery.explanation || '';
        const created = discovery.created ? formatDateTime(discovery.created) : '‚Äî';
        const saId = discovery.sa_id || '‚Äî';
        const url = discovery.url || '';

        // Format explanation - convert "Article:" to link if URL exists
        let formattedExplanation = escapeHtml(explanation);
        if (url && formattedExplanation.includes('Article:')) {
            formattedExplanation = formattedExplanation.replace(/Article:\s*([^|]+)/, `Article: <a href="${escapeHtml(url)}" target="_blank">$1</a>`);
        }
        // Replace | with line breaks
        formattedExplanation = formattedExplanation.replace(/\s*\|\s*/g, '<br>');

        return `
            <div class="holdings-history-panel">
                <div class="discovery-header">
                    ${advisorLogo ? `<img src="${escapeHtml(advisorLogo)}" alt="${advisor}" class="discovery-logo">` : ''}
                    <div class="discovery-text">
                        <h3 class="holdings-history-title">Discovered by ${advisor}</h3>
                        <h5 class="holdings-history-subtitle">${created} ¬∑ SA #${saId}</h5>
                    </div>
                </div>
                <div class="discovery-explanation holdings-history-text">${formattedExplanation}</div>
            </div>
        `;
    }

    // Render health history section
    function renderHealthHistorySection(healthHistory) {
        if (!healthHistory || healthHistory.length === 0) return '';

        const healthRecords = healthHistory.map(health => {
            const date = formatDate(health.created);
            const score = health.score != null ? health.score.toFixed(1) : '‚Äî';
            const confidenceScore = health.confidence_score;
            const healthScore = health.health_score;
            const valuationScore = health.valuation_score;
            const piotroski = health.piotroski;
            const altmanZ = health.altman_z;
            const geminiWeight = health.gemini_weight;
            const geminiRec = health.gemini_rec;
            const geminiExplanation = health.gemini_explanation;

            const hasGeminiDataForColumns = geminiWeight != null || geminiRec != null;

            return `
                <div class="health-record" data-health-id="${health.id}">
                    <div class="health-record-header">
                        <h3 class="holdings-history-title">Health check ${date}</h3>
                        <div class="health-record-score">Score ${score}</div>
                    </div>
                    <div class="health-record-meta ${!hasGeminiDataForColumns ? 'health-record-meta-single' : ''}">
                        <div class="health-meta-section">
                            <div class="health-meta-label">Algorithm Components</div>
                            ${confidenceScore != null ? `<div class="health-meta-item holdings-history-text"><span class="health-meta-key">Confidence Score:</span> <span class="health-meta-value">${escapeHtml(confidenceScore)}</span></div>` : ''}
                            ${healthScore != null ? `<div class="health-meta-item holdings-history-text"><span class="health-meta-key">Health Score:</span> <span class="health-meta-value">${escapeHtml(healthScore)}</span></div>` : ''}
                            ${valuationScore != null ? `<div class="health-meta-item holdings-history-text"><span class="health-meta-key">Valuation Score:</span> <span class="health-meta-value">${escapeHtml(valuationScore)}</span></div>` : ''}
                            ${piotroski != null ? `<div class="health-meta-item holdings-history-text"><span class="health-meta-key">Piotroski:</span> <span class="health-meta-value">${escapeHtml(piotroski.toString())}/4</span></div>` : ''}
                            ${altmanZ != null ? `<div class="health-meta-item holdings-history-text"><span class="health-meta-key">Altman Z:</span> <span class="health-meta-value">${escapeHtml(altmanZ)}</span></div>` : ''}
                        </div>
                        ${hasGeminiDataForColumns ? `
                        <div class="health-meta-section">
                            <div class="health-meta-label">Gemini Analysis</div>
                            ${geminiWeight != null ? `<div class="health-meta-item holdings-history-text"><span class="health-meta-key">Weight:</span> <span class="health-meta-value">${escapeHtml(geminiWeight)}</span></div>` : ''}
                            ${geminiRec != null ? `<div class="health-meta-item holdings-history-text"><span class="health-meta-key">Recommendation:</span> <span class="health-meta-value">${escapeHtml(geminiRec)}</span></div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                    ${geminiExplanation ? `<div class="health-meta-explanation-full holdings-history-text">${formatGeminiExplanation(geminiExplanation)}</div>` : ''}
                </div>
            `;
        }).join('');

        return `<div class="health-history-section">${healthRecords}</div>`;
    }

    // Render trade history section
    function renderTradeHistorySection(trades) {
        if (!trades || trades.length === 0) return '';

        const tradesHtml = trades.map(trade => {
            const action = escapeHtml(trade.action || 'UNKNOWN');
            const shares = trade.shares || 0;
            const price = formatCurrency(trade.price);
            const plAmount = trade.pl_amount != null ? formatCurrency(trade.pl_amount) : '‚Äî';
            const plPercent = trade.pl_percent != null ? formatPercent(trade.pl_percent) : '‚Äî';
            const plClass = trade.pl_class || 'neutral';
            const created = formatDateTime(trade.created);
            const actionClass = action.toLowerCase();

            return `
                <div class="holdings-row holdings-grid-trades" data-trade-id="${trade.id}">
                    <div class="holdings-col">
                        <span class="trade-action ${actionClass}">${action}</span>
                    </div>
                    <div class="holdings-col">
                        <span class="holdings-price">${price}</span>
                    </div>
                    <div class="holdings-col">
                        <span>${shares}</span>
                    </div>
                    <div class="holdings-col">
                        <span class="${plClass}">${plAmount}</span>
                    </div>
                    <div class="holdings-col">
                        <span class="${plClass}">${plPercent}</span>
                    </div>
                    <div class="holdings-col">
                        <span class="trade-timestamp">${created}</span>
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="holdings-history-panel">
                <div class="holdings-history-content">
                    <div class="holdings-grid-trades-header">
                        <div class="holdings-col">Action</div>
                        <div class="holdings-col">Price</div>
                        <div class="holdings-col">Shares</div>
                        <div class="holdings-col">P&L</div>
                        <div class="holdings-col">P&L %</div>
                        <div class="holdings-col">Date</div>
                    </div>
                    ${tradesHtml}
                </div>
            </div>
        `;
    }

    // Render sell instructions section
    function renderSellInstructionsSection(sellInstructions, currentPrice) {
        if (!sellInstructions || !sellInstructions.length) {
            return '';
        }

        const instructionEmojis = {
            'STOP_LOSS': 'üõë',
            'STOP_PRICE': 'üõë',
            'STOP_PERCENTAGE': 'üõë',
            'TARGET_PRICE': 'üéØ',
            'TARGET_PERCENTAGE': 'üéØ',
            'CS_FLOOR': 'üìâ',
            'AFTER_DAYS': 'üìÖ',
            'DESCENDING_TREND': 'üìâ',
        };

        const instructionLabels = {
            'STOP_LOSS': 'STOP LOSS',
            'STOP_PRICE': 'STOP PRICE',
            'STOP_PERCENTAGE': 'STOP %',
            'TARGET_PRICE': 'TARGET PRICE',
            'TARGET_PERCENTAGE': 'TARGET %',
            'CS_FLOOR': 'CS FLOOR',
            'AFTER_DAYS': 'AFTER DAYS',
            'DESCENDING_TREND': 'DESCENDING TREND',
        };

        const entries = sellInstructions.map((inst) => {
            const emoji = instructionEmojis[inst.instruction] || 'üìå';
            const label = instructionLabels[inst.instruction] || inst.instruction;
            let valueDisplay = '';
            let extraInfo = '';

            if (['STOP_LOSS', 'STOP_PERCENTAGE', 'STOP_PRICE'].includes(inst.instruction) && inst.value != null) {
                valueDisplay = formatCurrency(inst.value);
                if (inst.current_price != null) {
                    const diff = inst.current_price - inst.value;
                    const diffPercent = inst.current_price > 0 ? ((diff / inst.current_price) * 100) : 0;
                    extraInfo = ` (${diffPercent >= 0 ? '+' : ''}${diffPercent.toFixed(1)}% from current)`;
                }
            } else if (['TARGET_PRICE', 'TARGET_PERCENTAGE'].includes(inst.instruction) && inst.value != null) {
                valueDisplay = formatCurrency(inst.value);
                if (inst.current_price != null) {
                    const upside = inst.value - inst.current_price;
                    const upsidePercent = inst.current_price > 0 ? ((upside / inst.current_price) * 100) : 0;
                    extraInfo = ` (+${upsidePercent.toFixed(1)}% upside)`;
                }
            } else if (inst.instruction === 'AFTER_DAYS' && inst.value != null) {
                valueDisplay = `${inst.value} days`;
                if (inst.days_held != null) {
                    const remaining = Math.max(0, inst.value - inst.days_held);
                    extraInfo = ` (${inst.days_held} days held, ${remaining} remaining)`;
                }
            } else if (inst.instruction === 'CS_FLOOR' && inst.value != null) {
                valueDisplay = inst.value.toFixed(2);
                if (inst.current_consensus != null) {
                    const diff = inst.current_consensus - inst.value;
                    extraInfo = ` (Current: ${inst.current_consensus.toFixed(2)}, ${diff >= 0 ? '+' : ''}${diff.toFixed(2)} above floor)`;
                }
            } else if (inst.instruction === 'DESCENDING_TREND' && inst.value != null) {
                valueDisplay = `${(inst.value * 100).toFixed(1)}%`;
                if (inst.current_trend != null) {
                    const diff = inst.current_trend - inst.value;
                    extraInfo = ` (Current trend: ${(inst.current_trend * 100).toFixed(1)}%, ${diff >= 0 ? '+' : ''}${(diff * 100).toFixed(1)}% from threshold)`;
                }
            }

            const statusIndicator = inst.status === 'active' ? ' ‚ö†Ô∏è TRIGGERED' : '';
            const text = `${emoji} ${label}: ${valueDisplay}${extraInfo}${statusIndicator}`;
            
            return `
                <div class="holdings-history-text sell-instruction-entry">${escapeHtml(text)}</div>
            `;
        }).join('');

        return `
            <div class="holdings-history-panel">
                ${entries}
            </div>
        `;
    }

    // Main rendering logic
    try {
        const headingSection = renderHeadingSection(data.heading);
        const discoverySection = renderDiscoverySection(data.discovery);
        const healthHistorySection = renderHealthHistorySection(data.health_history || []);
        const tradeHistorySection = renderTradeHistorySection(data.trades || []);
        const sellInstructionsSection = renderSellInstructionsSection(
            data.sell_instructions || [],
            data.heading ? data.heading.price : null
        );

        return headingSection + discoverySection + healthHistorySection + tradeHistorySection + sellInstructionsSection;
    } catch (error) {
        console.error('Error rendering holdings history:', error);
        return '<div class="error">Error loading holdings history. Please try again.</div>';
    }
};

// Update detailPanelRenderer to delegate to holdingHistoryRenderer when available
const originalDetailPanelRenderer = window.detailPanelRenderer;
window.detailPanelRenderer = function(data) {
    if (typeof window.holdingHistoryRenderer === 'function') {
        return window.holdingHistoryRenderer(data);
    }
    if (typeof originalDetailPanelRenderer === 'function') {
        return originalDetailPanelRenderer(data);
    }
    return '<div>Loading...</div>';
};
</script>
{% endblock %}

